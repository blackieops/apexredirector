#!/usr/bin/env bash
set -euf -o pipefail

# -----------------------------------------------------------------------------
# This script does a full release of apexredirector by automating:
#
#     1. a Git tag for the version;
#     2. pushes the new commit and tag;
#     3. builds and pushes a new Docker container image; and finally
#     4. cross-compiles a matrix of executables for publishing.
#
# This should ease the entire process of releasing new versions.
# -----------------------------------------------------------------------------

VERSION="${1:-}"

if [ "$VERSION" = "" ] ; then
	echo "You must specify the version number as the only argument."
	exit 1
fi

main() {
	bin/build-releases "$VERSION"
	bin/publish-container "$VERSION"
	git tag "$VERSION"
	git push --tags
}

main
