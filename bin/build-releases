#!/usr/bin/env bash
set -xeuf -o pipefail

# -----------------------------------------------------------------------------
# This script generates a matrix of static binaries for distribution.
#
# There isn't much here; really this is just a convenience script to run
# `go build` a bunch of times automatically.
# -----------------------------------------------------------------------------

TARGET_OS=(
	"darwin"
	"linux"
)

TARGET_ARCH=(
	"arm64"
	"amd64"
)

VERSION="${1:-}"

if [ "$VERSION" = "" ] ; then
	echo "You must specify a version number as the first argument."
	exit 1
fi

main() {
	mkdir -p release

	for OS in "${TARGET_OS[@]}" ; do
		for ARCH in "${TARGET_ARCH[@]}" ; do
			BASENAME="apexredirector-$VERSION-$OS-$ARCH"
			CGO_ENABLED=0 GOOS="$OS" GOARCH="$ARCH" go build -o "release/$BASENAME" .
			pushd release
				tar -czf "$BASENAME.tar.gz" "$BASENAME"
				shasum -a 512 "$BASENAME" > "$BASENAME.sha512"
			popd
		done
	done
}

main
